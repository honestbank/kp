"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[997],{5781:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>o,default:()=>m,frontMatter:()=>a,metadata:()=>r,toc:()=>d});const r=JSON.parse('{"id":"middlewares/metrics","title":"Metrics","description":"The metrics middleware is a middleware for the KP library that tracks various metrics about the message processing, such as the duration of each operation and the number of successes and failures. These metrics are collected using the Prometheus library and can be pushed to a Prometheus gateway to be stored and visualized.","source":"@site/docs/middlewares/metrics.md","sourceDirName":"middlewares","slug":"/middlewares/metrics","permalink":"/kp/docs/middlewares/metrics","draft":false,"unlisted":false,"editUrl":"https://github.com/honestbank/kp/edit/main/docs/docs/middlewares/metrics.md","tags":[],"version":"current","sidebarPosition":5,"frontMatter":{"sidebar_position":5},"sidebar":"tutorialSidebar","previous":{"title":"Backoff","permalink":"/kp/docs/middlewares/backoff"},"next":{"title":"Tracing","permalink":"/kp/docs/middlewares/tracing"}}');var s=n(4848),i=n(8453);const a={sidebar_position:5},o="Metrics",c={},d=[{value:"Metrics Collected",id:"metrics-collected",level:3},{value:"Example",id:"example",level:3}];function l(e){const t={admonition:"admonition",code:"code",h1:"h1",h3:"h3",header:"header",p:"p",pre:"pre",...(0,i.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(t.header,{children:(0,s.jsx)(t.h1,{id:"metrics",children:"Metrics"})}),"\n",(0,s.jsx)(t.p,{children:"The metrics middleware is a middleware for the KP library that tracks various metrics about the message processing, such as the duration of each operation and the number of successes and failures. These metrics are collected using the Prometheus library and can be pushed to a Prometheus gateway to be stored and visualized."}),"\n",(0,s.jsx)(t.admonition,{type:"warning",children:(0,s.jsx)(t.p,{children:"The metrics middleware should be added after the backoff middleware to avoid measuring the wait times. However, you can choose to add it before the backoff middleware if you want to include the wait times in the metrics."})}),"\n",(0,s.jsx)(t.p,{children:"The metrics middleware is a useful tool for tracking the performance and stability of the KP library and the message processing. By adding it to the middleware chain, you can collect and monitor various metrics about the message processing and use them to improve the system."}),"\n",(0,s.jsx)(t.h3,{id:"metrics-collected",children:"Metrics Collected"}),"\n",(0,s.jsx)(t.p,{children:"The metrics middleware collects the following metrics:"}),"\n",(0,s.jsxs)(t.p,{children:[(0,s.jsx)(t.code,{children:"kp_operation_duration_milliseconds"}),": A histogram of the duration of each operation, in milliseconds, labeled by the result (success or failure) and the error (if any)."]}),"\n",(0,s.jsx)(t.h3,{id:"example",children:"Example"}),"\n",(0,s.jsxs)(t.p,{children:["To use the metrics middleware, you first need to import the middlewares/measurements package and call the ",(0,s.jsx)(t.code,{children:"NewMeasurementMiddleware"})," function:"]}),"\n",(0,s.jsx)(t.p,{children:"The gatewayURL argument is the URL of the Prometheus gateway to which the metrics should be pushed, and the applicationName argument is the name of the application that will be used as the job name in the metrics."}),"\n",(0,s.jsx)(t.p,{children:"Then, you can add the metrics middleware to the KP instance by calling the AddMiddleware method:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-go",children:'package main\n\nimport (\n\t"context"\n\t"fmt"\n\t"time"\n\n\tbackoff_policy "github.com/honestbank/backoff-policy"\n\t"github.com/honestbank/backoff-policy/policies"\n\tv2 "github.com/honestbank/kp/v2"\n\tconsumer2 "github.com/honestbank/kp/v2/consumer"\n\t"github.com/honestbank/kp/v2/middlewares/consumer"\n\t"github.com/honestbank/kp/v2/middlewares/measurement/pushgateway"\n)\n\ntype UserLoggedInEvent struct {\n\tUserID string\n}\n\nfunc getConsumer() consumer2.Consumer {\n    // omitted for brevity\n\treturn nil\n}\n\nfunc main() {\n\tapplicationName := "send-login-notification-worker"\n\tkp := v2.New[kafka.Message]()\n\tkp.AddMiddleware(consumer.NewConsumerMiddleware(getConsumer()))\n\tkp.AddMiddleware(pushgateway.NewMeasurementMiddleware("http://path/to/push/gateway", applicationName)) // simply add a measurement middleware to get free metrics\n\terr := kp.Process(processUserLoggedInEvent)\n\tif err != nil {\n\t\tpanic(err) // do better error handling\n\t}\n}\n\nfunc processUserLoggedInEvent(ctx context.Context, message *kafka.Message) error {\n\t// here, you can focus on your business logic.\n\tfmt.Printf("processing %v\\n", message)\n\ttime.Sleep(time.Millisecond * 200) // simulate long running process\n\treturn nil                         // or error\n}\n\nfunc getConfig() any {\n\treturn nil // return your config\n}\n'})}),"\n",(0,s.jsx)(t.admonition,{type:"warning",children:(0,s.jsx)(t.p,{children:"The metrics middleware starts a background job that pushes the metrics to the Prometheus gateway every 5 seconds. Make sure that the gateway is running and accessible from the application."})})]})}function m(e={}){const{wrapper:t}={...(0,i.R)(),...e.components};return t?(0,s.jsx)(t,{...e,children:(0,s.jsx)(l,{...e})}):l(e)}},8453:(e,t,n)=>{n.d(t,{R:()=>a,x:()=>o});var r=n(6540);const s={},i=r.createContext(s);function a(e){const t=r.useContext(i);return r.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function o(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:a(e.components),r.createElement(i.Provider,{value:t},e.children)}}}]);