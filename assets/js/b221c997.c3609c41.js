"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[72],{829:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>l,contentTitle:()=>i,default:()=>u,frontMatter:()=>c,metadata:()=>o,toc:()=>a});const o=JSON.parse('{"id":"middlewares/graceful-shutdown","title":"graceful shutdown","description":"The gracefulshutdown middleware is designed to handle the syscall.SIGINT, syscall.SIGTERM, syscall.SIGHUP, and syscall.SIGQUIT signals gracefully, by allowing you to stop your processor in a controlled manner.","source":"@site/docs/middlewares/graceful-shutdown.md","sourceDirName":"middlewares","slug":"/middlewares/graceful-shutdown","permalink":"/kp/docs/middlewares/graceful-shutdown","draft":false,"unlisted":false,"editUrl":"https://github.com/honestbank/kp/edit/main/docs/docs/middlewares/graceful-shutdown.md","tags":[],"version":"current","sidebarPosition":10,"frontMatter":{"sidebar_position":10},"sidebar":"tutorialSidebar","previous":{"title":"deadletter","permalink":"/kp/docs/middlewares/deadletter"},"next":{"title":"Write your own","permalink":"/kp/docs/middlewares/custom-middleware"}}');var t=s(4848),r=s(8453);const c={sidebar_position:10},i="graceful shutdown",l={},a=[{value:"Usage",id:"usage",level:2}];function d(e){const n={code:"code",h1:"h1",h2:"h2",header:"header",p:"p",pre:"pre",...(0,r.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"graceful-shutdown",children:"graceful shutdown"})}),"\n",(0,t.jsxs)(n.p,{children:["The ",(0,t.jsx)(n.code,{children:"gracefulshutdown"})," middleware is designed to handle the ",(0,t.jsx)(n.code,{children:"syscall.SIGINT"}),", ",(0,t.jsx)(n.code,{children:"syscall.SIGTERM"}),", ",(0,t.jsx)(n.code,{children:"syscall.SIGHUP"}),", and ",(0,t.jsx)(n.code,{children:"syscall.SIGQUIT"})," signals gracefully, by allowing you to stop your processor in a controlled manner."]}),"\n",(0,t.jsxs)(n.p,{children:["The ",(0,t.jsx)(n.code,{children:"gracefulshutdown"})," middleware simply calls the next function passed to it, and does not modify or affect the item in any way. However, it does register a callback function that will be called when a SIGINT signal is received by the process."]}),"\n",(0,t.jsx)(n.p,{children:"This allows you to cleanly shut down your processor, for example, by closing any open resources or waiting for in-flight messages to be processed before exiting."}),"\n",(0,t.jsx)(n.h2,{id:"usage",children:"Usage"}),"\n",(0,t.jsxs)(n.p,{children:["To use the sigint middleware, you first need to create a new instance of it by calling ",(0,t.jsx)(n.code,{children:"gracefulshutdown.NewSigIntMiddleware[T](stopFunction func())"}),". The stopFunction parameter is a callback function that will be called when a one of the ",(0,t.jsx)(n.code,{children:"syscall.SIGINT"}),", ",(0,t.jsx)(n.code,{children:"syscall.SIGTERM"}),", ",(0,t.jsx)(n.code,{children:"syscall.SIGHUP"}),", or ",(0,t.jsx)(n.code,{children:"syscall.SIGQUIT"})," signal is received."]}),"\n",(0,t.jsx)(n.p,{children:"Then, you can use the middleware in your pipeline by passing it to the Process method of KP."}),"\n",(0,t.jsx)(n.p,{children:"Here's an example of how you might use this middleware in a simple pipeline:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:'package main\n\nimport (\n\t"context"\n\t"fmt"\n\t"time"\n\n\t"github.com/confluentinc/confluent-kafka-go/kafka"\n\tv2 "github.com/honestbank/kp/v2"\n\tconsumer2 "github.com/honestbank/kp/v2/consumer"\n\t"github.com/honestbank/kp/v2/middlewares/consumer"\n\t"github.com/honestbank/kp/v2/middlewares/gracefulshutdown"\n)\n\nfunc main() {\n\tc, err := consumer.New([]string{"topic-1", "topic-2"}, getConfig())\n\tif err != nil {\n\t\t// handle err\n\t}\n\tconsumerMiddleware := consumer.NewConsumerMiddleware(c)\n\tprocessor := v2.New[kafka.Message]()\n\tprocessor.AddMiddleware(gracefulshutdown.NewSignalMiddleware(func() {\n\t\tprocessor.Stop()\n\t}))\n\tprocessor.AddMiddleware(consumerMiddleware)\n\tprocessor.Process(processUserLoggedInEvent)\n}\n\nfunc processUserLoggedInEvent(ctx context.Context, message *kafka.Message) error {\n\t// here, you can focus on your business logic.\n\tfmt.Printf("processing %v\\n", message)\n\ttime.Sleep(time.Millisecond * 200) // simulate long-running process\n\treturn nil                         // or error\n}\n\nfunc getConfig() any {\n\treturn nil // return your config\n}\n'})}),"\n",(0,t.jsxs)(n.p,{children:["This will stop the processor when the process receives one of ",(0,t.jsx)(n.code,{children:"syscall.SIGINT"}),", ",(0,t.jsx)(n.code,{children:"syscall.SIGTERM"}),", ",(0,t.jsx)(n.code,{children:"syscall.SIGHUP"}),", or ",(0,t.jsx)(n.code,{children:"syscall.SIGQUIT"})," signal."]})]})}function u(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},8453:(e,n,s)=>{s.d(n,{R:()=>c,x:()=>i});var o=s(6540);const t={},r=o.createContext(t);function c(e){const n=o.useContext(r);return o.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:c(e.components),o.createElement(r.Provider,{value:n},e.children)}}}]);