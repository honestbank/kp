"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[111],{7773:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>d,contentTitle:()=>a,default:()=>m,frontMatter:()=>o,metadata:()=>r,toc:()=>c});const r=JSON.parse('{"id":"middlewares/custom-middleware","title":"Write your own","description":"Middlewares are a powerful way to customize the behavior of the library by intercepting and modifying the processing of messages. They are implemented as implementations of the KPMiddleware interface, which has a single method:","source":"@site/docs/middlewares/custom-middleware.md","sourceDirName":"middlewares","slug":"/middlewares/custom-middleware","permalink":"/kp/docs/middlewares/custom-middleware","draft":false,"unlisted":false,"editUrl":"https://github.com/honestbank/kp/edit/main/docs/docs/middlewares/custom-middleware.md","tags":[],"version":"current","sidebarPosition":11,"frontMatter":{"sidebar_position":11},"sidebar":"tutorialSidebar","previous":{"title":"graceful shutdown","permalink":"/kp/docs/middlewares/graceful-shutdown"},"next":{"title":"Examples","permalink":"/kp/docs/category/examples"}}');var s=t(4848),i=t(8453);const o={sidebar_position:11},a="Write your own",d={},c=[{value:"Example: Log Middleware",id:"implementation",level:3},{value:"Usage",id:"usage",level:3}];function l(e){const n={a:"a",code:"code",h1:"h1",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,i.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"write-your-own",children:"Write your own"})}),"\n",(0,s.jsx)(n.p,{children:"Middlewares are a powerful way to customize the behavior of the library by intercepting and modifying the processing of messages. They are implemented as implementations of the KPMiddleware interface, which has a single method:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"type KPMiddleware[T any] interface {\n\tProcess(ctx context.Context, item T, next func(ctx context.Context, item T) error) error\n}\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Definition of Middleware can be found ",(0,s.jsx)(n.a,{href:"https://github.com/honestbank/kp/blob/e5d8f1e0ec1cceaa898e6a1ed7f7b468021b7b74/v2/middlewares/interface.go#L5-L7",children:"here"})]}),"\n",(0,s.jsx)(n.p,{children:"The Process method is called for each message and receives the following arguments:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"ctx"}),": a context object that can be used to cancel the processing of messages or pass values between middlewares."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"item"}),": the message being processed."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"next"}),": a function that represents the next middleware in the chain. It should be called to pass the message to the next middleware, or to terminate the chain if it is the last middleware."]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"implementation",children:"Example: Log Middleware"}),"\n",(0,s.jsx)(n.p,{children:'Here is an example of a log middleware that logs "message processed at" and the current time whenever a message is processed:'}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:'package logmw\n\nimport (\n\t"context"\n\t"fmt"\n\n\t"github.com/confluentinc/confluent-kafka-go/kafka"\n\t"github.com/honestbank/kp/v2/internal/middleware"\n\t"github.com/honestbank/kp/v2/middlewares"\n)\n\ntype logMiddleware struct{}\n\nfunc (l logMiddleware) Process(ctx context.Context, item T, next func(ctx context.Context, item T) error) error {\n\tlog.Println("message processed at", time.Now())\n\treturn next(ctx, item)\n}\n\nfunc NewLogMiddleware() KPMiddleware[T] {\n\treturn &logMiddleware{}\n}\n'})}),"\n",(0,s.jsx)(n.h3,{id:"usage",children:"Usage"}),"\n",(0,s.jsx)(n.p,{children:"To use the log middleware simply add it like the following:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:'package main\n\nimport (\n\t"context"\n\tconsumer2 "github.com/honestbank/kp/v2/consumer"\n\t"github.com/honestbank/kp/v2/middlewares/consumer"\n\n\t"github.com/honestbank/kp/v2"\n\t"github.com/honestbank/kp/v2/middlewares/retry_count"\n)\n\nfunc getConsumer() consumer2.Consumer {\n    return nil\n}\n\nfunc main() {\n\tdefer setupTracing()() // this is important and not included in kp by default\n\tkp := v2.New[*kafka.Message]()\n\tkp.AddMiddleware(consumer.NewConsumerMiddleware(getConsumer()))\n\tkp.AddMiddleware(logmw.LogMiddleware())\n\terr := kp.Process(processUserLoggedInEvent)\n\tif err != nil {\n\t\tpanic(err) // do better error handling\n\t}\n}\n\nfunc processUserLoggedInEvent(ctx context.Context, message *kafka.Message) error {\n\t// here, you can focus on your business logic.\n\tfmt.Printf("processing %v\\n", message)\n\ttime.Sleep(time.Millisecond * 200) // simulate long-running process\n\treturn nil                         // or error\n}\n\nfunc getConfig() any {\n\treturn nil // return your config\n}\n'})})]})}function m(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(l,{...e})}):l(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>o,x:()=>a});var r=t(6540);const s={},i=r.createContext(s);function o(e){const n=r.useContext(i);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),r.createElement(i.Provider,{value:n},e.children)}}}]);